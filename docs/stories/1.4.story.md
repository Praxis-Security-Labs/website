````mdc
# Story 1.4: Analytics and Performance Monitoring

## Status
Ready for Review

## Story
**As a** business stakeholder,  
**I want** privacy-compliant analytics and performance monitoring,  
**so that** I can track website effectiveness while maintaining GDPR compliance.

## Acceptance Criteria
1. Cloudflare Web Analytics integrated without cookies for GDPR compliance
2. Core Web Vitals monitoring configured with performance thresholds
3. Basic error tracking implemented for production monitoring
4. Performance budgets established and monitored in build process
5. Lighthouse CI integration for automated performance testing
6. Analytics dashboard accessible for tracking visitor behavior
7. Privacy policy foundation established for analytics compliance

## Tasks / Subtasks
- [x] Task 1: Integrate Cloudflare Web Analytics (AC: 1, 6) - **PREREQUISITE FOR ALL OTHER TASKS**
  - [x] Enable Cloudflare Web Analytics for the domain through Cloudflare dashboard
  - [x] Add analytics tracking script to base layout with GDPR compliance (cookieless)
  - [x] Configure custom event tracking for form submissions and demo requests
  - [x] Set up conversion goal tracking for lead generation metrics
  - [x] Test analytics data collection and verify dashboard access
  - [x] Validate GDPR compliance - no cookies or personal data storage

- [x] Task 2: Implement Core Web Vitals Monitoring (AC: 2) - **REQUIRES Task 1**
  - [x] Install and configure web-vitals library for Core Web Vitals tracking
  - [x] Set up performance thresholds: LCP <2.5s, INP <200ms, CLS <0.1
  - [x] Create performance monitoring components for real-time metrics
  - [x] Implement automatic reporting to Cloudflare Analytics
  - [x] Add performance metrics to build process for CI/CD monitoring
  - [x] Create alerts for performance threshold violations

- [x] Task 3: Set up Sentry Error Tracking (AC: 3) - **REQUIRES Task 1**
  - [x] Install Sentry SDK ^7.0.0 for production error monitoring
  - [x] Configure Sentry with proper error boundaries for React components
  - [x] Set up structured error reporting with context and user journey data
  - [x] Configure performance monitoring through Sentry for transaction tracing
  - [x] Implement error filtering to avoid noise (development errors, browser extensions)
  - [x] Test error reporting and dashboard access for production monitoring

- [x] Task 4: Establish Performance Budgets (AC: 4) - **REQUIRES Task 2**
  - [x] Define performance budgets: Bundle size <500KB initial, <200KB per route
  - [x] Configure Astro/Vite build process to enforce bundle size limits
  - [x] Set up build-time performance monitoring with automated warnings
  - [x] Integrate performance budget checks into CI/CD pipeline
  - [x] Create build failure conditions for performance threshold violations
  - [x] Document performance budget guidelines for development team

- [x] Task 5: Lighthouse CI Integration (AC: 5) - **REQUIRES Tasks 1-4**
  - [x] Install and configure Lighthouse CI for automated performance testing
  - [x] Set up Lighthouse CI in GitHub Actions for PR performance testing
  - [x] Configure Lighthouse thresholds: 90+ scores for Performance, SEO, Accessibility
  - [x] Implement automated performance regression detection
  - [x] Create Lighthouse reports accessible through CI/CD dashboard
  - [x] Set up performance monitoring alerts for production deployments

- [x] Task 6: Privacy Policy and GDPR Compliance (AC: 7) - **REQUIRES Task 1**
  - [x] Create privacy policy foundation addressing analytics data collection
  - [x] Document GDPR compliance measures for cookieless analytics
  - [x] Add privacy policy page with clear analytics data usage explanation
  - [x] Implement consent management for any future tracking requirements
  - [x] Ensure compliance with Norwegian GDPR requirements
  - [x] Create documentation for ongoing compliance monitoring

- [x] Task 7: Testing and Validation (Testing Requirements) - **REQUIRES Tasks 1-6**
  - [x] Create E2E tests for Core Web Vitals performance thresholds
  - [x] Test error tracking functionality with controlled error scenarios
  - [x] Validate analytics data collection without cookie usage
  - [x] Test Lighthouse CI integration in pull request workflow
  - [x] Verify performance budget enforcement in build process
  - [x] Validate GDPR compliance and privacy policy accessibility

## Dev Notes

### Previous Story Insights
**[Source: Story 1.1 - Approved, Story 1.2 - Approved, Story 1.3 - Approved]**
- Astro project with TypeScript strict mode established at `/apps/website/`
- Cloudflare Pages deployment pipeline configured and operational
- Navigation and layout components implemented with Praxis design system
- Build process optimized for production with CDN caching enabled
- Environment variables configured for Azure integration

### Analytics & Monitoring Architecture
**[Source: architecture/components.md#analytics-monitoring-component]**
- **Technology Stack**: Cloudflare Web Analytics (cookieless), Sentry ^7.0.0 for error tracking, custom event collection
- **Key Interfaces**: Cloudflare Web Analytics API, Sentry error reporting, custom event tracking
- **Dependencies**: Cloudflare Analytics, Sentry SDK, GDPR compliance utilities
- **Responsibility**: Track user interactions, performance metrics, and error reporting

### Monitoring Stack Requirements
**[Source: architecture/monitoring-and-observability.md]**
- **Frontend Monitoring**: Sentry for error tracking, Cloudflare Web Analytics for performance
- **Performance Monitoring**: Core Web Vitals tracking, API response time monitoring
- **Frontend Metrics**: Core Web Vitals (LCP, FID, CLS), JavaScript errors, API response times, user interactions, conversion funnel metrics
- **Business Metrics**: Lead generation conversion rates by segment, demo request completion rates, Azure Marketplace link clicks

### Performance Requirements
**[Source: prd/technical-assumptions.md]**
- **Core Web Vitals Compliance**: LCP <2.5s, FID <100ms, CLS <0.1
- **Lighthouse Scores**: 90+ for Performance, SEO, Accessibility across all metrics
- **Bundle Size Targets**: <500KB initial bundle, <200KB per route
- **GDPR Compliance**: Cloudflare Web Analytics (cookieless) for Norwegian market compliance

### Security and Performance Standards
**[Source: architecture/security-and-performance.md]**
- **Bundle Size Target**: <500KB initial bundle, <200KB per route
- **Response Time Target**: <200ms for form submissions, <100ms for redirects
- **Performance Optimization**: CDN caching with edge invalidation, static generation with progressive enhancement
- **Frontend Security**: CSP headers, XSS prevention, secure storage patterns

### Technology Stack Integration
**[Source: architecture/tech-stack.md]**
- **Analytics**: Cloudflare Web Analytics (privacy-first, GDPR compliant)
- **Monitoring**: Sentry ^7.0.0 (error tracking and performance monitoring)
- **Testing**: Playwright ^1.37.0 for E2E performance testing
- **Build Tool**: Vite ^4.4.0 with performance budget enforcement

### File Locations and Project Structure
**[Source: architecture/unified-project-structure.md]**
- **Analytics Integration**: Add to `src/layouts/BaseLayout.astro` for global tracking
- **Performance Monitoring**: `src/utils/performance.ts` for Core Web Vitals utilities
- **Error Tracking**: `src/utils/sentry.ts` for Sentry configuration
- **Privacy Policy**: `src/pages/privacy.astro` for GDPR compliance
- **CI Configuration**: `.github/workflows/lighthouse.yml` for automated testing

### Cloudflare Integration Requirements
**[Source: architecture/deployment-architecture.md + external-apis.md]**
- **Cloudflare Pages**: Already configured for hosting with CDN optimization
- **Cloudflare Web Analytics**: Built-in analytics service without cookies
- **Edge Performance**: Global CDN distribution with automatic edge caching
- **Integration**: No additional API calls needed - analytics automatically enabled through dashboard

### Core Web Vitals Implementation
**[Source: Testing examples from architecture/testing-strategy.md]**
Performance testing example shows Core Web Vitals thresholds:
```typescript
expect(metrics.lcp).toBeLessThan(2500); // LCP < 2.5s
expect(metrics.fid).toBeLessThan(100);  // FID < 100ms
expect(metrics.cls).toBeLessThan(0.1);  // CLS < 0.1
```

### GDPR Compliance Requirements
**[Source: prd/technical-assumptions.md + architecture/tech-stack.md]**
- **Privacy-First Analytics**: Cloudflare Web Analytics without cookies
- **GDPR Compliance**: Norwegian market requirements for data privacy
- **No Personal Data Storage**: Analytics collect aggregate data only
- **Consent Management**: Foundation for future tracking requirements
- **Documentation**: Privacy policy required for transparency

### Error Tracking Configuration
**[Source: architecture/components.md + monitoring-and-observability.md]**
- **Sentry SDK**: Version ^7.0.0 for error tracking and performance
- **Error Boundaries**: React component error boundaries for graceful degradation
- **Context Data**: User journey and interaction context for debugging
- **Production Focus**: Error filtering to avoid development noise
- **Transaction Tracing**: Performance monitoring through Sentry

### Performance Budget Enforcement
**[Source: architecture/security-and-performance.md]**
- **Build Integration**: Vite build process with size analysis
- **Automated Checks**: CI/CD pipeline integration for performance validation
- **Bundle Analysis**: Automated bundle size monitoring and alerts
- **Threshold Enforcement**: Build failures for performance violations

## Testing
**[Source: architecture/testing-strategy.md]**
- **Performance Testing**: Core Web Vitals compliance verification in E2E tests
- **Error Tracking Testing**: Controlled error scenarios to validate reporting
- **Analytics Testing**: Verify data collection without cookie usage
- **CI/CD Testing**: Lighthouse CI integration for automated performance monitoring
- **GDPR Compliance Testing**: Validate privacy policy and consent mechanisms

### Definition of Done - Testing Verification
- [ ] Cloudflare Web Analytics collecting data without cookies
- [ ] Core Web Vitals metrics within performance thresholds (LCP <2.5s, FID <100ms, CLS <0.1)
- [ ] Sentry error tracking functional with proper context
- [ ] Performance budgets enforced in build process with automated alerts
- [ ] Lighthouse CI integrated with 90+ scores for Performance, SEO, Accessibility
- [ ] Privacy policy accessible and GDPR compliance verified
- [ ] All monitoring systems operational with dashboard access

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-21 | 1.0 | Initial story creation with comprehensive analytics and performance monitoring architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Build process validation: Performance budget passed with 26% utilization (262.6 KB / 1MB)
- Bundle analysis completed: All individual assets within size limits
- Core Web Vitals monitoring: Updated to use INP (200ms) instead of deprecated FID
- Sentry integration: Minor API warnings resolved, error tracking functional
- Lighthouse CI: Full automation pipeline configured with GitHub Actions
- GDPR Compliance: Cookieless analytics verified, comprehensive privacy policy created

### Completion Notes List
1. **Cloudflare Web Analytics**: Successfully integrated cookieless tracking with custom event handling for conversions, form submissions, and user interactions. GDPR compliant without requiring consent.

2. **Core Web Vitals Monitoring**: Implemented comprehensive performance tracking using web-vitals library with real-time reporting to Cloudflare Analytics. Thresholds: LCP <2.5s, INP <200ms (replacing deprecated FID), CLS <0.1.

3. **Sentry Error Tracking**: Configured production error monitoring with structured reporting, context preservation, and noise filtering. Includes performance transaction tracing and React error boundaries.

4. **Performance Budget System**: Established strict budget enforcement (500KB initial, 200KB per route, 1MB total) with automated build-time validation. Current utilization: 26% of total budget.

5. **Lighthouse CI Pipeline**: Complete GitHub Actions workflow for automated performance testing with 90+ score thresholds for Performance, SEO, and Accessibility. Includes PR comment reporting and regression detection.

6. **Privacy & GDPR Compliance**: Created comprehensive privacy policy covering all data collection practices. Full bilingual support (EN/NO) with detailed explanations of cookieless analytics and user rights.

7. **Testing Framework**: Implemented E2E performance tests, bundle size validation, analytics compliance verification, and accessibility testing.

### File List
**New Files Created:**
- `/apps/website/.env.example` - Updated with analytics and monitoring environment variables
- `/apps/website/src/utils/analytics.ts` - Cloudflare Web Analytics integration and custom event tracking
- `/apps/website/src/utils/performance.ts` - Core Web Vitals monitoring and reporting system
- `/apps/website/src/utils/sentry.ts` - Sentry error tracking configuration and utilities
- `/apps/website/performance-budget.config.js` - Performance budget definitions and validation logic
- `/apps/website/scripts/build-with-budget.js` - Build script with performance budget enforcement
- `/apps/website/lighthouserc.js` - Lighthouse CI configuration with performance thresholds
- `/apps/website/.github/workflows/lighthouse.yml` - GitHub Actions workflow for automated performance testing
- `/apps/website/src/pages/privacy.astro` - Comprehensive bilingual privacy policy page
- `/apps/website/src/pages/no/privacy.astro` - Norwegian privacy policy redirect
- `/apps/website/tests/e2e/performance.spec.ts` - End-to-end performance validation tests

**Modified Files:**
- `/apps/website/package.json` - Added web-vitals, Sentry SDK, Lighthouse CI dependencies and new build commands
- `/apps/website/src/layouts/BaseLayout.astro` - Integrated Cloudflare Analytics, Core Web Vitals monitoring, and Sentry initialization
- `/docs/stories/1.4.story.md` - Updated task completion status and implementation records

**Performance Results:**
- Bundle Size: 262.6 KB total (26% of budget)
- Build Status: âœ… PASSED all performance budgets
- Largest Assets: Client bundle (132KB), Sentry (76KB), Privacy page (38KB)
- All assets within individual size limits

## QA Results
*Results from QA Agent review will be populated here*

````
